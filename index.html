<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Manuten√ß√£o - Gold Redutores</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color: #003366; background-color: #fff; }
        .header { text-align: center; border-bottom: 3px solid #ed1c24; padding-bottom: 10px; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 24px; text-transform: uppercase; }
        .section { background: #d9d9d9; padding: 6px; margin-top: 15px; font-weight: bold; text-align: center; border: 1px solid #333; text-transform: uppercase; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-bottom: 0; }
        table, th, td { border: 1px solid #333; }
        td { padding: 6px; font-size: 11px; vertical-align: middle; }
        th { background: #eee; padding: 8px; font-size: 11px; text-align: center; color: #003366; }
        input[type="text"], input[type="number"], textarea { width: 98%; border: none; outline: none; background: transparent; font-size: 11px; color: #000; }
        
        .autocomplete-wrapper { position: relative; overflow: visible !important; }
        .suggestions { 
            position: absolute; background: white; border: 2px solid #333; 
            width: 180%; z-index: 99999; max-height: 250px; overflow-y: auto; 
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3); display: none; left: 0; top: 100%;
        }
        .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; color: #000; text-align: left; }
        .suggestion-item:hover { background-color: #ed1c24; color: white; }

        .foto-upload-container { text-align: center; padding: 15px; background: #f4f4f4; border: 2px dashed #ccc; margin: 10px 0; border-radius: 5px; }
        .foto-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .foto-item { border: 1px solid #333; padding: 8px; text-align: center; background: #fff; position: relative; page-break-inside: avoid; display: flex; flex-direction: column; }
        .foto-preview { max-width: 100%; height: auto; max-height: 300px; object-fit: contain; margin-bottom: 8px; }

        .btn-remove { position: absolute; top: 5px; right: 5px; background: #ed1c24; color: white; border: none; cursor: pointer; padding: 3px 10px; font-weight: bold; border-radius: 3px; z-index: 10; }

        .no-print { margin: 15px 0; }
        .btn-group { text-align: right; margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
        button { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-pdf { background: #003366; }
        .btn-wpp { background: #25d366; }
        
        @media print { 
            .no-print, .suggestions, .btn-remove, .foto-upload-container, .btn-group { display: none !important; } 
            .section { -webkit-print-color-adjust: exact; background-color: #d9d9d9 !important; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>RELAT√ìRIO DE MANUTEN√á√ÉO PREVENTIVA</h2>
        <div style="margin-top: 10px;">
            <label style="font-weight: bold;">N¬∫ ORDEM DE SERVI√áO: </label>
            <input type="text" id="input-os" style="width: 150px; border-bottom: 2px solid #ed1c24; text-align: center; font-weight: bold; font-size: 18px;" placeholder="Ex: 5449" oninput="buscarDadosOS()">
        </div>
    </div>

    <div class="no-print" style="text-align: center;">
        <span id="db-status" style="font-size: 12px; font-weight: bold; color: orange;">‚è≥ Sincronizando com GitHub...</span>
    </div>

    <div class="section">DADOS DO CLIENTE E EQUIPAMENTO</div>
    <table>
        <tr>
            <td colspan="2"><label><strong>Cliente:</strong></label> <input type="text" id="campo-cliente"></td>
            <td colspan="2"><label><strong>Data:</strong></label> <span id="data-atual" style="font-weight: bold;"></span></td>
        </tr>
        <tr>
            <td><label><strong>Redutor:</strong></label> <input type="text" id="campo-redutor"></td>
            <td><label><strong>Redu√ß√£o:</strong></label> <input type="text" id="campo-reducao" placeholder="Ex: 1:40"></td>
            <td colspan="2"><label><strong>S√©rie:</strong></label> <input type="text" id="campo-serie"></td>
        </tr>
    </table>

    <div class="section">AN√ÅLISES FOTOGR√ÅFICAS</div>
    <div class="foto-upload-container no-print">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">üì∏ ADICIONAR FOTOS</label>
        <input type="file" accept="image/*" multiple onchange="previewFotos(event)">
    </div>
    <div id="container-fotos" class="foto-container"></div>

    <div class="section">PE√áAS NECESS√ÅRIAS PARA EXECU√á√ÉO</div>
    <table>
        <thead>
            <tr>
                <th style="width: 65%;">Descri√ß√£o (Busca Global: termo % termo)</th>
                <th>Qtd</th>
                <th>C√≥d Gold</th>
            </tr>
        </thead>
        <tbody id="tabela-pecas"></tbody>
    </table>

    <div class="section">RESUMO DE M√ÉO DE OBRA</div>
    <table>
        <tbody>
            <tr><td>DESMONTAGEM DO EQUIPAMENTO</td><td><input type="number" class="hr-input" oninput="calcularTotal()"></td><td>SVG1192</td></tr>
            <tr><td>DESCONTAMINACAO DE PECAS</td><td><input type="number" class="hr-input" oninput="calcularTotal()"></td><td>SVG1193</td></tr>
            <tr><td>ANALISE E PERITAGEM EM PECAS</td><td><input type="number" class="hr-input" oninput="calcularTotal()"></td><td>SVG1194</td></tr>
            <tr><td>MONTAGEM E AJUSTE DE FOLGAS</td><td><input type="number" class="hr-input" oninput="calcularTotal()"></td><td>SVG1210</td></tr>
            <tr><td>TESTES FINAIS DO EQUIPAMENTO</td><td><input type="number" class="hr-input" oninput="calcularTotal()"></td><td>SVG1200</td></tr>
        </tbody>
        <tfoot>
            <tr style="background:#f2f2f2; font-weight:bold;">
                <td style="text-align: right; padding-right: 15px;">TOTAL DE HORAS T√âCNICAS:</td>
                <td id="total-horas" style="text-align: center; color: #ed1c24; font-size: 14px;">0</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <div class="section">CONCLUS√ïES</div>
    <textarea id="conclusoes" rows="5" style="width: 100%; border: 1px solid #333; margin-top: 5px; padding: 8px;" placeholder="Parecer t√©cnico final..."></textarea>

    <div class="btn-group no-print">
        <button class="btn-pdf" onclick="window.print()">IMPRIMIR / PDF</button>
        <button class="btn-wpp" onclick="enviarWhatsApp()">ENVIAR WHATSAPP (COM DADOS)</button>
    </div>

    <script>
        const URL_CSV_OS = 'https://raw.githubusercontent.com/Gold-Redutores/PRENCHIMENTO-OS-GOLD/main/dmsoser00000045.csv';
        const URL_CSV_PRODUTOS = 'https://raw.githubusercontent.com/Gold-Redutores/PRENCHIMENTO-OS-GOLD/main/relatlisatagemprodutosdetalhada.csv';
        let dadosOS = []; let listaProdutos = [];

        function parseCSV(text) {
            return text.split(/\r?\n/).map(linha => {
                return linha.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
            }).filter(l => l.length > 5);
        }

        async function carregarDados() {
            const status = document.getElementById('db-status');
            try {
                const [resOS, resProd] = await Promise.all([ fetch(URL_CSV_OS), fetch(URL_CSV_PRODUTOS) ]);
                dadosOS = parseCSV(await resOS.text());
                listaProdutos = parseCSV(await resProd.text());
                status.innerText = "‚úÖ GitHub Sincronizado!";
                status.style.color = "green";
            } catch (e) {
                status.innerText = "‚ùå Erro na sincroniza√ß√£o.";
                status.style.color = "red";
            }
        }

        function buscarDadosOS() {
            const osVal = document.getElementById('input-os').value.trim();
            if (osVal.length < 3) return;
            const linha = dadosOS.find(l => l[21] === osVal);
            if (linha) {
                const campos = { 'campo-serie': 23, 'campo-redutor': 24, 'campo-cliente': 26 };
                for (let id in campos) {
                    let input = document.getElementById(id);
                    input.value = linha[campos[id]] || "";
                    input.setAttribute('value', input.value);
                }
            }
        }

        function criarLinhaPeca() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="autocomplete-wrapper">
                    <input type="text" class="input-nome-peca" placeholder="Busca global...">
                    <div class="suggestions"></div>
                </td>
                <td><input type="number" value="1" style="text-align:center;" oninput="this.setAttribute('value', this.value)"></td>
                <td><input type="text" class="cod-gold" readonly style="text-align:center;"></td>
            `;
            const input = tr.querySelector('.input-nome-peca');
            const sugestoes = tr.querySelector('.suggestions');
            const codInput = tr.querySelector('.cod-gold');

            input.addEventListener('input', function() {
                const busca = this.value.toLowerCase();
                sugestoes.innerHTML = '';
                if (busca.length < 2) { sugestoes.style.display = 'none'; return; }
                const termos = busca.split('%').map(t => t.trim()).filter(t => t !== "");
                
                // Busca Global em todas as colunas
                const filtrados = listaProdutos.filter(p => {
                    const linhaToda = p.join(" ").toLowerCase();
                    return termos.every(t => linhaToda.includes(t));
                }).slice(0, 15);

                if (filtrados.length > 0) {
                    sugestoes.style.display = 'block';
                    filtrados.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        // √çndices do seu CSV: p[21] = C√≥digo, p[22] = Descri√ß√£o
                        div.innerText = `${p[21]} | ${p[22]}`;
                        div.onclick = () => {
                            input.value = p[22]; input.setAttribute('value', p[22]);
                            codInput.value = p[21]; codInput.setAttribute('value', p[21]);
                            sugestoes.style.display = 'none';
                            if (tr === document.querySelector('#tabela-pecas tr:last-child')) criarLinhaPeca();
                        };
                        sugestoes.appendChild(div);
                    });
                } else { sugestoes.style.display = 'none'; }
            });
            document.getElementById('tabela-pecas').appendChild(tr);
        }

        function previewFotos(e) {
            for (let f of e.target.files) {
                const r = new FileReader();
                r.onload = ev => {
                    const d = document.createElement('div');
                    d.className = 'foto-item';
                    d.innerHTML = `
                        <button class="btn-remove no-print" onclick="this.parentElement.remove()">X</button>
                        <img src="${ev.target.result}" class="foto-preview">
                        <textarea rows="3" placeholder="Parecer..." oninput="this.innerHTML = this.value"></textarea>
                    `;
                    document.getElementById('container-fotos').appendChild(d);
                };
                r.readAsDataURL(f);
            }
        }

        function enviarWhatsApp() {
            // GRAVA OS DADOS NO HTML ANTES DE ENVIAR
            document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
            document.querySelectorAll('textarea').forEach(t => t.innerHTML = t.value);

            const os = document.getElementById('input-os').value || "SN";
            const cliente = document.getElementById('campo-cliente').value || "RELATORIO";
            const htmlCompleto = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
            const blob = new Blob([htmlCompleto], { type: 'text/html' });
            const arquivo = new File([blob], `OS_${os}_${cliente}.html`, { type: 'text/html' });

            if (navigator.share) {
                navigator.share({ title: `Relat√≥rio OS ${os}`, files: [arquivo] }).catch(console.error);
            } else {
                alert("Navegador n√£o suporta compartilhamento. Use Imprimir > Salvar PDF.");
            }
        }

        function calcularTotal() {
            let t = 0; 
            document.querySelectorAll('.hr-input').forEach(i => t += (parseFloat(i.value) || 0));
            document.getElementById('total-horas').innerText = t;
            document.querySelectorAll('input[type="number"]').forEach(i => i.setAttribute('value', i.value));
        }

        window.onclick = e => { if (!e.target.matches('.input-nome-peca')) document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none'); }

        window.onload = () => {
            document.getElementById('data-atual').innerText = new Date().toLocaleDateString('pt-BR');
            carregarDados();
            criarLinhaPeca();
        };
    </script>
</body>
</html>
