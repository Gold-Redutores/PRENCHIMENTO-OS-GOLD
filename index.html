<script>
    const URL_CSV_OS = 'https://raw.githubusercontent.com/Gold-Redutores/PRENCHIMENTO-OS-GOLD/main/dmsoser00000045.csv';
    const URL_CSV_PRODUTOS = 'https://raw.githubusercontent.com/Gold-Redutores/PRENCHIMENTO-OS-GOLD/main/relatlisatagemprodutosdetalhada.csv';

    let dadosOS = [];
    let listaProdutos = [];

    async function carregarDados() {
        const status = document.getElementById('db-status');
        try {
            const [resOS, resProd] = await Promise.all([ fetch(URL_CSV_OS), fetch(URL_CSV_PRODUTOS) ]);
            
            const textOS = await resOS.text();
            // Filtra linhas que realmente contém dados de OS (começam com o nome da empresa ou similar e possuem a OS na posição 20)
            dadosOS = textOS.split(/\r?\n/)
                .map(linha => linha.split('","').map(c => c.replace(/"/g, '').trim()))
                .filter(colunas => colunas.length > 20);

            const textProd = await resProd.text();
            // Filtra linhas de produtos (o código Gold está na coluna 16 e nome na 17)
            listaProdutos = textProd.split(/\r?\n/)
                .map(linha => linha.split('","').map(c => c.replace(/"/g, '').trim()))
                .filter(colunas => colunas.length > 17 && colunas[16] !== "Código");

            status.innerText = "✅ GitHub Sincronizado!";
            status.style.color = "green";
        } catch (e) {
            status.innerText = "❌ Erro de Sincronização.";
            status.style.color = "red";
        }
    }

    function buscarDadosOS() {
        const osVal = document.getElementById('input-os').value.trim();
        if (osVal.length < 3) return;

        // Procura a OS na coluna de índice 20
        const linha = dadosOS.find(l => l[20] === osVal);
        
        if (linha) {
            document.getElementById('campo-serie').value = linha[22] || "";
            document.getElementById('campo-redutor').value = linha[23] || "";
            document.getElementById('campo-cliente').value = linha[24] || "";
        }
    }

    function criarLinhaPeca() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="autocomplete-wrapper">
                <input type="text" class="input-nome-peca" placeholder="Peça...">
                <div class="suggestions"></div>
            </td>
            <td><input type="number" value="1" style="text-align:center;"></td>
            <td><input type="text" class="cod-gold" readonly style="text-align:center;"></td>
        `;
        
        const input = tr.querySelector('.input-nome-peca');
        const sugestoes = tr.querySelector('.suggestions');
        const codInput = tr.querySelector('.cod-gold');

        input.addEventListener('input', function() {
            const busca = this.value.toLowerCase();
            sugestoes.innerHTML = '';
            if (busca.length < 2) { sugestoes.style.display = 'none'; return; }

            const termos = busca.split('%');
            
            // Busca na coluna 17 (Nome do Produto)
            const filtrados = listaProdutos.filter(p => {
                const nome = p[17].toLowerCase();
                return termos.every(termo => nome.includes(termo));
            }).slice(0, 12);

            if (filtrados.length > 0) {
                sugestoes.style.display = 'block';
                filtrados.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${p[16]} - ${p[17]}`; // Código - Nome
                    div.onclick = () => {
                        input.value = p[17];
                        codInput.value = p[16];
                        sugestoes.style.display = 'none';
                        if (tr === document.querySelector('#tabela-pecas tr:last-child')) criarLinhaPeca();
                    };
                    sugestoes.appendChild(div);
                });
            } else { sugestoes.style.display = 'none'; }
        });

        document.getElementById('tabela-pecas').appendChild(tr);
    }
    // ... restante das funções (calcularTotal, previewFotos) permanecem iguais
</script>
